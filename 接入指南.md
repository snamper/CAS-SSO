# 用户中心接入指南

## 项目说明
此用户中心是采用[CAS](https://apereo.github.io/cas/4.2.x/protocol/CAS-Protocol-Specification.html "CAS protocol specification")框架开发的，CAS的原理如下：
![CAS1](http://img.blog.csdn.net/20160905134331993 "CAS原理图1")

### 用户首次登陆时，流程如下：
1. 用户浏览器访问系统A需登录受限资源，此时进行登录检查，发现未登录，然后进行获取票据操作，发现没有票据(ST，Service Ticket)
2. 重定向到用户中心，此时，由于用户还未在用户中心进行登陆，全局会话还未建立，执行登陆操作
3. 登录成功后，认证中心重定向请求到系统A，并附上认证通过令牌（ST），此时认证中心同时生成了全局票据（TGC）
4. 此时再次进行登录检查，发现未登录，但是此时已经有了用户中心给系统A发送的ST令牌，调用用户中心的接口，获取登陆用户的信息
5. 将用户中心返回的用户信息，存入到session中，生成局部会话，此时用户就在系统A中完成了登陆操作

![CAS2](http://img.blog.csdn.net/20160905134415791 "CAS原理图2")

### 已登陆用户首次访问系统B时，流程如下：
1. 浏览器访问另一应用B需登录受限资源，此时进行登录检查，发现未登录，然后进行获取票据操作，发现没有票据
2. 重定向到用户中心，此时，由于用户之前已经在用户中心进行过登陆操作，所以用户中心直接重定向回系统B，并附上认证通过令牌(ST)
3. 此时再次进行登录检查，发现未登录，但是此时已经有了用户中心给系统B发送的ST令牌，调用用户中心的接口，获取登陆用户的信息
4. 将用户中心返回的用户信息，存入到session中，生成局部会话，此时用户就在系统A中完成了登陆操作

## 接入指南
在接入用户中心时，需要在用户中心申请权限，由于暂未开发用户中心管理后台，所以目前需要联系用户中心相关人员获取。

### 需要用户中心提供的东西有
* app key，应用app key，在调用用户中心接口时，需要用来做认证
* app secret，应用app secret，在调用用户中心接口时，需要用来做认证

### 需要提供给用户中心的东西有
* 项目路径，在单点登陆过程中，用户中心需要将ST附在子应用的链接后面，然后进行重定向。为了安全，所有子应用的链接都必须在用户中心报备，否则用户中心不会给子应用发送ST。例如，项目域名为http://demo.com，项目目录为test，那么项目路径即为http://demo.com/test
* 登出链接url，用户在注销登陆时，不仅要销毁用户中心的全局会话，还要销毁各个子应用的局部会话，具体详情，可以参见接入Demo里面的logout.php

### 接入Demo
接入Demo在项目的Demo目录下

### Api说明

#### 获取已登陆用户的信息

##### 说明
凭票据获取已登陆的用户信息

##### 请求地址
https://passport.linghit.com/api/userInfo?appKey=appKey&appSecret=appSecret&code=code

##### 接口请求方式
GET

##### 参数
| 参数名 | 是否必填 | 类型 | 说明 |
| ----- | ------- | ---- | ---- |
| appKey | 是 | string | app key |
| appSecret | 是 | string | app secret |
| code | 是| string | 临时票据 |

##### 返回
此接口以json格式返回数据，无论请求是否成功，都会返回errcode和errmsg，可以利用errcode来判断请求是否成功

###### 正确返回样式
	{
		"errcode": 0,
		"errmsg": "",
		"id": 1,
		"mobile": "13911111111",
		"email": "test@qq.com",
		"realname": "张三",
		"oauth_type": "dingding",
		"identifier": "fdafadfafa"
	}

###### 错误返回样式
	{
		"errcode": 1,
		"errmsg": "参数错误"
	}

